(()=>{"use strict";class t{constructor(...t){throw new Error("[@googlemaps/js-api-loader]: The Loader class is no longer available in this version.\nPlease use the new functional API: setOptions() and importLibrary().\nFor more information, see the updated documentation at: https://github.com/googlemaps/js-api-loader/blob/main/README.md")}}const e=()=>{const e=document.querySelector("[data-batp-itinerary-form]");if(!e)return;const n=e.querySelector("[data-batp-duration]"),a=e.querySelector("[data-batp-duration-output]"),o=document.querySelector("[data-batp-map-placeholder]"),i=e.querySelector("[data-batp-geo-trigger]"),r=e.querySelector('input[name="neighborhood"]'),s=e.querySelector('input[name="latitude"]'),l=e.querySelector('input[name="longitude"]'),d=Array.from(e.querySelectorAll('.batp-itinerary-chip input[type="checkbox"]'));if(n&&a){const t=()=>{a.textContent=`${n.value}h`};t(),n.addEventListener("input",t)}i&&navigator.geolocation&&i.addEventListener("click",()=>{i.disabled=!0,i.innerHTML='<span class="dashicons dashicons-update" style="animation: spin 1s linear infinite;"></span>',navigator.geolocation.getCurrentPosition(t=>{const e=t.coords.latitude,n=t.coords.longitude;s&&(s.value=e),l&&(l.value=n),r&&(r.value="Current Location"),i.innerHTML='<span class="dashicons dashicons-yes" style="color: green;"></span>',setTimeout(()=>{i.disabled=!1,i.innerHTML='<span class="dashicons dashicons-location" style="color: var(--batp-highlight-color);"></span>'},2e3)},t=>{console.warn("Geolocation error:",t),i.disabled=!1,i.innerHTML='<span class="dashicons dashicons-warning" style="color: orange;"></span>',alert("Could not detect location. Please enter it manually.")})}),d.forEach(t=>{t.addEventListener("change",()=>{t.closest(".batp-itinerary-chip").classList.toggle("is-selected",t.checked)})});let c=null,p=null;e.addEventListener("submit",async n=>{n.preventDefault();const a=e.dataset.nonce,i=e.dataset.apiUrl,r=e.dataset.googleMapsKey;if(!a||!i)return void console.error("BATP: Missing API configuration.");const s=new FormData(e),l={neighborhood:s.get("neighborhood"),interests:s.getAll("interests[]"),budget:s.get("budget"),accessibility_preferences:s.getAll("accessibility_preferences[]"),latitude:s.get("latitude")||null,longitude:s.get("longitude")||null,duration:60*Number(s.get("duration")),nonce:a};e.dataset.state="loading",o&&(o.innerHTML='<div class="batp-itinerary-map__placeholder"><p class="batp-itinerary-map__eyebrow">GENERATING...</p></div>');try{const n=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":a},body:JSON.stringify(l)}),s=await n.json();if(!n.ok)throw new Error(s.message||s.code||"An unknown error occurred.");e.dataset.state="idle",((e,n)=>{e.candidates;const a=e.itinerary?.items||[];if(0===a.length)return void(o&&(o.innerHTML='<div style="padding:1rem;">No itinerary items found.</div>'));const i=[],r=new Map(e.candidates.map(t=>[t.slug,t]));if(a.forEach(t=>{const e=r.get(t.slug);e&&e.data?.latitude&&e.data?.longitude&&i.push({lat:parseFloat(e.data.latitude),lng:parseFloat(e.data.longitude),title:t.title})}),n&&i.length>0)(async(e,n=[])=>{if(!o)return;o.innerHTML='<div style="height:100%; width:100%; border-radius: 16px;"></div>';const a=o.firstElementChild;try{p||(p=new t({apiKey:e,version:"weekly",libraries:["places","geometry"]}));const o=await p.load(),{Map:i}=await o.maps.importLibrary("maps"),{AdvancedMarkerElement:r}=await o.maps.importLibrary("marker"),s=n.length>0?{lat:n[0].lat,lng:n[0].lng}:{lat:40.6782,lng:-73.9442};if(c=new i(a,{center:s,zoom:13,mapId:"DEMO_MAP_ID",disableDefaultUI:!0,zoomControl:!0}),n.length>0){const t=new o.maps.LatLngBounds;if(n.forEach((e,n)=>{const a={lat:e.lat,lng:e.lng},o=document.createElement("div");o.className="batp-map-marker",o.innerHTML=`<span style="background:#ff4f5e; color:#fff; border-radius:50%; width:24px; height:24px; display:flex; align-items:center; justify-content:center; font-weight:bold; box-shadow:0 2px 4px rgba(0,0,0,0.2);">${n+1}</span>`,new r({map:c,position:a,content:o,title:e.title}),t.extend(a)}),n.length>1){const t=n.map(t=>({lat:t.lat,lng:t.lng}));new o.maps.Polyline({path:t,geodesic:!0,strokeColor:"#ff4f5e",strokeOpacity:1,strokeWeight:3,map:c})}c.fitBounds(t)}}catch(t){console.error("Map init error:",t),o.innerHTML='<div class="batp-itinerary-map__error"><p>Unable to load map.</p></div>'}})(n,i);else if(o){const t=a.map((t,e)=>`\n\t\t\t\t\t<div style="margin-bottom: 0.5rem; text-align: left;">\n\t\t\t\t\t\t<strong>${e+1}. ${t.title}</strong>\n\t\t\t\t\t\t<div style="font-size: 0.9em; color: #666;">${t.notes||""}</div>\n\t\t\t\t\t</div>\n\t\t\t\t`).join("");o.innerHTML=`\n\t\t\t\t\t<div style="padding: 1.5rem; width: 100%; overflow-y: auto; max-height: 320px;">\n\t\t\t\t\t\t<h3 style="margin-top: 0;">Your Itinerary</h3>\n\t\t\t\t\t\t${t}\n\t\t\t\t\t</div>\n\t\t\t\t`}})(s,r),e.dispatchEvent(new CustomEvent("batp-itinerary-success",{detail:s}))}catch(t){console.error("BATP Error:",t),e.dataset.state="idle",d=t.message,o&&(o.innerHTML=`\n\t\t\t<div class="batp-itinerary-map__error" style="color: #d00; padding: 1rem;">\n\t\t\t\t<p><strong>Error:</strong> ${d}</p>\n\t\t\t</div>\n\t\t`)}var d})};"loading"!==document.readyState?e():document.addEventListener("DOMContentLoaded",e)})();