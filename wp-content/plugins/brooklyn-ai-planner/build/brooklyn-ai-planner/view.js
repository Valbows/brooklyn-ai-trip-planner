(()=>{const t=()=>{const t=document.querySelector("[data-batp-itinerary-form]");if(!t)return;const e=document.getElementById("batp-results-area"),a=document.getElementById("batp-list-output"),n=document.getElementById("batp-map-root"),o=document.querySelector("[data-batp-results-meta]"),s=document.querySelectorAll(".batp-tabs__btn"),i=Array.from(t.querySelectorAll('.batp-form__chip input[type="checkbox"]')),l=document.getElementById("batp-neighborhood-select"),r=document.getElementById("batp-lat-input"),c=document.getElementById("batp-lng-input"),d=document.getElementById("batp-location-status"),p=t=>{t&&t.dataset.lat&&t.dataset.lng&&(r.value=t.dataset.lat,c.value=t.dataset.lng,d&&(d.textContent=""))};if(l){const t=l.options[l.selectedIndex];p(t),l.addEventListener("change",t=>{const e=t.target.options[t.target.selectedIndex];"current_location"===e.value?(d&&(d.textContent="üì° Getting location..."),navigator.geolocation?navigator.geolocation.getCurrentPosition(t=>{r.value=t.coords.latitude,c.value=t.coords.longitude,d&&(d.textContent="‚úÖ Location found!"),console.log("BATP Geolocation:",t.coords.latitude,t.coords.longitude)},t=>{console.error("Geolocation error:",t),d&&(d.textContent="‚ùå Location failed"),alert("Could not get your location. Please select a neighborhood."),l.value="Brooklyn Heights",p(l.options[l.selectedIndex])},{enableHighAccuracy:!0,timeout:1e4}):(alert("Geolocation is not supported by your browser."),l.value="Brooklyn Heights",p(l.options[l.selectedIndex]))):p(e)})}i.forEach(t=>{t.addEventListener("change",()=>{t.closest(".batp-form__chip").classList.toggle("is-selected",t.checked)})}),s.forEach(t=>{t.addEventListener("click",()=>{s.forEach(t=>t.classList.remove("is-active")),t.classList.add("is-active");const e=t.dataset.tab;document.querySelectorAll(".batp-view-content").forEach(t=>{t.classList.remove("is-active")}),document.getElementById(`batp-view-${e}`).classList.add("is-active"),"map"===e&&g&&setTimeout(()=>{google.maps.event.trigger(g,"resize")},100)})});let g=null;const u=(s,i)=>{const l=s.itinerary?.items||[];if(0===l.length)return void alert("No results found. Try different filters.");if(e&&(e.classList.add("is-active"),e.scrollIntoView({behavior:"smooth"})),o){const e=t.querySelector('select[name="duration"]').value;o.textContent=`${l.length} venues found ‚Ä¢ ${e} hours available`}const r=[],c=new Map((s.candidates||[]).map(t=>[t.slug,t])),d=s.directions?.overview_url||"#";l.forEach((t,e)=>{const a=c.get(t.slug),n=a?.data?.latitude,o=a?.data?.longitude;console.log(`BATP Map: Item ${e+1} (${t.slug}):`,{lat:n,lng:o,title:t.title}),n&&o&&0!==n&&0!==o?r.push({lat:parseFloat(n),lng:parseFloat(o),title:t.title,placeId:t.slug}):console.warn(`BATP Map: Missing coordinates for item ${e+1}: ${t.title}`)}),console.log("BATP Map: Total locations for map:",r.length);const p="#"!==d?d:(t=>{if(0===t.length)return"#";const e=`${t[0].lat},${t[0].lng}`,a=`${t[t.length-1].lat},${t[t.length-1].lng}`,n=t.slice(1,-1).map(t=>`${t.lat},${t.lng}`).join("|");let o=`https://www.google.com/maps/dir/?api=1&origin=${e}&destination=${a}&travelmode=walking`;return n&&(o+=`&waypoints=${n}`),o})(r);let u=[...l];const m=e=>{if(!a)return;const n=`\n\t\t\t\t<div class="batp-route-header">\n\t\t\t\t\t<a href="${p}" target="_blank" class="batp-route-btn" data-event-action="directions_click" data-place-id="full_route">\n\t\t\t\t\t\t<span class="dashicons dashicons-location-alt"></span> \n\t\t\t\t\t\t<strong>Get Full Route Directions</strong>\n\t\t\t\t\t\t<span class="batp-route-btn__subtitle">Open all ${e.length} stops in Google Maps</span>\n\t\t\t\t\t</a>\n\t\t\t\t</div>\n\t\t\t`;a.innerHTML=n+e.map((t,e)=>{const a=c.get(t.slug),n=a?.data||{},o=n.website||"#",s=n.phone_number||n.phone||"",i=n.address||"",l=((t,e)=>{if(e&&e.length>10)return e;if(t.vibe_summary)return t.vibe_summary;const a=[],n=t.rating?`${t.rating}‚òÖ`:"",o=t.price_level?"$".repeat(t.price_level):"",s=t.types?.slice(0,2).map(t=>t.replace(/_/g," ")).join(", ")||"";return n&&a.push(`Rated ${n}`),o&&a.push(o),s&&a.push(s),a.length>0?a.join(" ‚Ä¢ "):"A local Brooklyn favorite."})(n,t.description);let r="See hours on website";var d;n.hours?r=(d=n.hours)?d[["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][(new Date).getDay()]]||"Open today":"See website for hours":n.opening_hours?.open_now&&(r="Open now");let p="#";p=n.latitude&&n.longitude?`https://www.google.com/maps/dir/?api=1&destination=${n.latitude},${n.longitude}`:i?`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(i)}`:`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(t.title+", Brooklyn, NY")}`;const g=a?.place_id||t.slug||"";return`\n\t\t\t\t<div class="batp-card" data-slug="${t.slug}" data-access='${JSON.stringify(n.accessibility||[])}'>\n\t\t\t\t\t<button class="batp-card__remove" data-remove-slug="${t.slug}" title="Remove from itinerary">√ó</button>\n\t\t\t\t\t<div class="batp-card__header">\n\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t<span class="batp-card__status">${!1!==n.opening_hours?.open_now?"Open Now":"Check Hours"}</span>\n\t\t\t\t\t\t\t<h3 class="batp-card__title">${e+1}. ${t.title}</h3>\n\t\t\t\t\t\t\t${n.rating?`<span class="batp-card__rating">‚≠ê ${n.rating}</span>`:""}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t\n\t\t\t\t\t<p class="batp-card__description">${l}</p>\n\t\t\t\t\t\n\t\t\t\t\t<div class="batp-card__details">\n\t\t\t\t\t\t${i?`<div><span class="dashicons dashicons-location"></span> ${i}</div>`:""}\n\t\t\t\t\t\t<div><span class="dashicons dashicons-clock"></span> ${r}</div>\n\t\t\t\t\t\t${s?`<a href="tel:${s.replace(/[^0-9+]/g,"")}" class="batp-card__link-row" data-event-action="phone_click" data-place-id="${g}"><span class="dashicons dashicons-phone"></span> ${s}</a>`:""}\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class="batp-card__footer">\n\t\t\t\t\t\t<a href="${p}" target="_blank" class="batp-card__btn-directions" data-event-action="directions_click" data-place-id="${g}">\n\t\t\t\t\t\t\t<span class="dashicons dashicons-location-alt"></span> Directions\n\t\t\t\t\t\t</a>\n\t\t\t\t\t\t<div class="batp-card__links">\n\t\t\t\t\t\t\t${"#"!==o?`<a href="${o}" target="_blank" data-event-action="website_click" data-place-id="${g}" data-event-meta='${JSON.stringify({url:o})}'><span class="dashicons dashicons-admin-site"></span> Website</a>`:""}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t`}).join(""),a.querySelectorAll(".batp-card__remove").forEach(e=>{e.addEventListener("click",a=>{a.preventDefault();const n=e.dataset.removeSlug;if(u=u.filter(t=>t.slug!==n),m(u),o){const e=t.querySelector('select[name="duration"]').value;o.textContent=`${u.length} venues found ‚Ä¢ ${e} hours available`}})})};m(u);const h=(t,e)=>{const a=document.getElementById(t);a&&e&&(e.onclick=t=>{t.preventDefault(),a.classList.add("is-open"),a.setAttribute("aria-hidden","false")},a.querySelectorAll("[data-modal-close]").forEach(t=>{t.onclick=t=>{t.preventDefault(),a.classList.remove("is-open"),a.setAttribute("aria-hidden","true")}}))},b=document.querySelector(".batp-results__btn--primary");h("batp-share-modal",b),b&&b.addEventListener("click",()=>{const t=document.getElementById("batp-summary-list");t&&(t.innerHTML=l.map(t=>`<li>${t.title}</li>`).join(""));const e=document.getElementById("batp-share-link-input");e&&(e.value=window.location.href)});const y=document.getElementById("batp-btn-copy-link");y&&(y.onclick=()=>{const t=document.getElementById("batp-share-link-input");t.select(),navigator.clipboard.writeText(t.value);const e=y.innerText;y.innerText="Copied!",setTimeout(()=>y.innerText=e,2e3)}),h("batp-filter-modal",document.querySelector(".batp-results__btn:nth-child(2)"));const v=document.getElementById("batp-apply-filters");v&&(v.onclick=()=>{const t=document.getElementById("batp-filter-modal"),e=t.querySelector('input[name="access_wheelchair"]').checked,n=t.querySelector('input[name="access_sensory"]').checked,o=t.querySelector('input[name="access_seating"]').checked;a.querySelectorAll(".batp-card").forEach(t=>{const a=JSON.parse(t.dataset.access||"[]");let s=!0;e&&!a.includes("wheelchair")&&(s=!1),n&&!a.includes("sensory")&&(s=!1),o&&!a.includes("seating")&&(s=!1),t.style.display=s?"flex":"none"}),t.classList.remove("is-open")}),i&&r.length>0&&setTimeout(()=>{(async(t,e=[])=>{if(n)try{let a,o;await(t=>new Promise((e,a)=>{if(window.google&&window.google.maps)return void e();if(document.querySelector('script[src*="maps.googleapis.com/maps/api/js"]'))return void e();const n=document.createElement("script");n.src=`https://maps.googleapis.com/maps/api/js?key=${t}&libraries=places,geometry,marker&v=weekly&loading=async`,n.async=!0,n.defer=!0,n.onload=()=>e(),n.onerror=t=>a(t),document.head.appendChild(n)}))(t),await new Promise((t,e)=>{let a=0;const n=()=>{a++,window.google&&window.google.maps&&window.google.maps.Map?t():a>50?e(new Error("Timeout waiting for google.maps.Map")):setTimeout(n,100)};n()});let s=!1;if("function"==typeof google.maps.importLibrary)try{const{Map:t}=await google.maps.importLibrary("maps"),{AdvancedMarkerElement:e}=await google.maps.importLibrary("marker");a=t,o=e}catch(t){console.warn("Modern map import failed, falling back to legacy",t),a=google.maps.Map,s=!0}else a=google.maps.Map,s=!0;if(!a)throw new Error("google.maps.Map constructor is missing");const i=e.length>0?{lat:e[0].lat,lng:e[0].lng}:{lat:40.6782,lng:-73.9442};if(g=new a(n,{center:i,zoom:13,mapId:"DEMO_MAP_ID",disableDefaultUI:!1,zoomControl:!0,streetViewControl:!1}),e.length>0){const t=new google.maps.LatLngBounds;e.forEach((e,a)=>{const n={lat:e.lat,lng:e.lng};if(!s&&o){const t=document.createElement("div");t.className="batp-map-marker",t.innerHTML=`<span style="background:#FF5F3D; color:#fff; border-radius:50%; width:32px; height:32px; display:flex; align-items:center; justify-content:center; font-weight:bold; box-shadow:0 2px 4px rgba(0,0,0,0.2); font-size:14px;">${a+1}</span>`,new o({map:g,position:n,content:t,title:e.title})}else new google.maps.Marker({map:g,position:n,label:{text:(a+1).toString(),color:"white",fontWeight:"bold"},title:e.title});t.extend(n)}),g.fitBounds(t)}}catch(t){console.error("Map init error:",t),n.innerHTML='<div style="padding:2rem; color:#d00;">Map failed to load.</div>'}})(i,r)},100)};a&&a.addEventListener("click",e=>{const a=e.target.closest("[data-event-action]");if(a){const e=a.dataset.eventAction,n=a.dataset.placeId||"",o=a.dataset.eventMeta?JSON.parse(a.dataset.eventMeta):{};console.log("BATP Analytics:",e,n,o),(async(e,a,n={})=>{const o=t.dataset.nonce,s=t.dataset.restNonce,i=t.dataset.apiUrl.replace("/itinerary","/events");if(console.log("BATP trackEvent:",e,a,n),!o||!i)return void console.warn("BATP trackEvent: Missing nonce or eventsUrl");const l={...n,source:"web_client"};try{const t=await fetch(i,{method:"POST",keepalive:!0,headers:{"Content-Type":"application/json",...s?{"X-WP-Nonce":s}:{}},body:JSON.stringify({action_type:e,place_id:a,metadata:l,nonce:o})});console.log("BATP trackEvent response:",t.status,t.ok)}catch(t){console.warn("BATP Analytics fail:",t)}})(e,n,o)}}),t.addEventListener("submit",async e=>{e.preventDefault();const a=t.dataset.nonce,n=t.dataset.restNonce,o=t.dataset.apiUrl,s=t.dataset.googleMapsKey;if(!a||!o)return;const i=new FormData(t),l=parseFloat(i.get("latitude"))||40.6782,r=parseFloat(i.get("longitude"))||-73.9442,c=i.get("neighborhood");console.log("BATP Form: Submitting with location:",{neighborhood:c,lat:l,lng:r});const d={neighborhood:c,lat:l,lng:r,interests:i.getAll("interests[]"),budget:i.get("budget"),duration:60*Number(i.get("duration")),nonce:a},p=t.querySelector('button[type="submit"]'),g=p.innerHTML;p.disabled=!0,p.innerHTML="Generating Plan...";try{const t=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json",...n?{"X-WP-Nonce":n}:{}},body:JSON.stringify(d)}),e=await t.json();if(!t.ok)throw new Error(e.message||"Error generating itinerary");u(e,s)}catch(t){console.error("BATP Error:",t),alert("Error: "+t.message)}finally{p.disabled=!1,p.innerHTML=g}})};"loading"!==document.readyState?t():document.addEventListener("DOMContentLoaded",t)})();