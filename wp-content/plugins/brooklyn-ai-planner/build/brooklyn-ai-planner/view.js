(()=>{const t=()=>{const t=document.querySelector("[data-batp-itinerary-form]");if(!t)return;const e=document.getElementById("batp-results-area"),a=document.getElementById("batp-list-output"),n=document.getElementById("batp-map-root"),o=document.querySelector("[data-batp-results-meta]"),s=document.querySelectorAll(".batp-tabs__btn");t.querySelector('input[name="neighborhood"]'),Array.from(t.querySelectorAll('.batp-form__chip input[type="checkbox"]')).forEach(t=>{t.addEventListener("change",()=>{t.closest(".batp-form__chip").classList.toggle("is-selected",t.checked)})}),s.forEach(t=>{t.addEventListener("click",()=>{s.forEach(t=>t.classList.remove("is-active")),t.classList.add("is-active");const e=t.dataset.tab;document.querySelectorAll(".batp-view-content").forEach(t=>{t.classList.remove("is-active")}),document.getElementById(`batp-view-${e}`).classList.add("is-active"),"map"===e&&i&&setTimeout(()=>{google.maps.event.trigger(i,"resize")},100)})});let i=null;const r=(s,r)=>{const l=s.itinerary?.items||[];if(0===l.length)return void alert("No results found. Try different filters.");if(e&&(e.classList.add("is-active"),e.scrollIntoView({behavior:"smooth"})),o){const e=t.querySelector('select[name="duration"]').value;o.textContent=`${l.length} venues found â€¢ ${e} hours available`}const c=[],d=new Map((s.candidates||[]).map(t=>[t.slug,t]));var p;l.forEach(t=>{const e=d.get(t.slug);e&&e.data?.latitude&&e.data?.longitude&&c.push({lat:parseFloat(e.data.latitude),lng:parseFloat(e.data.longitude),title:t.title})}),p=l,a&&(a.innerHTML=p.map((t,e)=>{const a=d.get(t.slug),n=a?.data||{},o=n.website||"#",s=n.phone_number||n.phone||"",i=n.address||"",r=n.vibe_summary||t.description||"",l=n.hours?(c=n.hours)?c[["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][(new Date).getDay()]]||"Open today":"See website for hours":"Open today";var c;let p="#";return p=n.latitude&&n.longitude?`https://www.google.com/maps/dir/?api=1&destination=${n.latitude},${n.longitude}`:i?`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(i)}`:`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(t.title+", Brooklyn, NY")}`,`\n\t\t\t\t<div class="batp-card" data-access='${JSON.stringify(n.accessibility||[])}'>\n\t\t\t\t\t<div class="batp-card__header">\n\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t<span class="batp-card__status">Open Now</span>\n\t\t\t\t\t\t\t<h3 class="batp-card__title">${e+1}. ${t.title}</h3>\n\t\t\t\t\t\t\t<span class="batp-card__tag">Best Match</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t\n\t\t\t\t\t<p class="batp-card__description">${r}</p>\n\t\t\t\t\t\n\t\t\t\t\t<div class="batp-card__details">\n\t\t\t\t\t\t${i?`<div><span class="dashicons dashicons-location"></span> ${i}</div>`:""}\n\t\t\t\t\t\t<div><span class="dashicons dashicons-clock"></span> ${l}</div>\n\t\t\t\t\t\t${s?`<div><span class="dashicons dashicons-phone"></span> ${s}</div>`:""}\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class="batp-card__footer">\n\t\t\t\t\t\t<a href="${p}" target="_blank" class="batp-card__btn-directions">\n\t\t\t\t\t\t\t<span class="dashicons dashicons-location-alt"></span> Directions\n\t\t\t\t\t\t</a>\n\t\t\t\t\t\t<div class="batp-card__links">\n\t\t\t\t\t\t\t${"#"!==o?`<a href="${o}" target="_blank"><span class="dashicons dashicons-admin-site"></span> Website</a>`:""}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t`}).join(""));const m=(t,e)=>{const a=document.getElementById(t);a&&e&&(e.onclick=t=>{t.preventDefault(),a.classList.add("is-open"),a.setAttribute("aria-hidden","false")},a.querySelectorAll("[data-modal-close]").forEach(t=>{t.onclick=t=>{t.preventDefault(),a.classList.remove("is-open"),a.setAttribute("aria-hidden","true")}}))},u=document.querySelector(".batp-results__btn--primary");m("batp-share-modal",u),u&&u.addEventListener("click",()=>{const t=document.getElementById("batp-summary-list");t&&(t.innerHTML=l.map(t=>`<li>${t.title}</li>`).join(""));const e=document.getElementById("batp-share-link-input");e&&(e.value=window.location.href)});const g=document.getElementById("batp-btn-copy-link");g&&(g.onclick=()=>{const t=document.getElementById("batp-share-link-input");t.select(),navigator.clipboard.writeText(t.value);const e=g.innerText;g.innerText="Copied!",setTimeout(()=>g.innerText=e,2e3)}),m("batp-filter-modal",document.querySelector(".batp-results__btn:nth-child(2)"));const h=document.getElementById("batp-apply-filters");h&&(h.onclick=()=>{const t=document.getElementById("batp-filter-modal"),e=t.querySelector('input[name="access_wheelchair"]').checked,n=t.querySelector('input[name="access_sensory"]').checked,o=t.querySelector('input[name="access_seating"]').checked;a.querySelectorAll(".batp-card").forEach(t=>{const a=JSON.parse(t.dataset.access||"[]");let s=!0;e&&!a.includes("wheelchair")&&(s=!1),n&&!a.includes("sensory")&&(s=!1),o&&!a.includes("seating")&&(s=!1),t.style.display=s?"flex":"none"}),t.classList.remove("is-open")}),r&&c.length>0&&setTimeout(()=>{(async(t,e=[])=>{if(n)try{let a,o;await(t=>new Promise((e,a)=>{if(window.google&&window.google.maps)return void e();if(document.querySelector('script[src*="maps.googleapis.com/maps/api/js"]'))return void e();const n=document.createElement("script");n.src=`https://maps.googleapis.com/maps/api/js?key=${t}&libraries=places,geometry,marker&v=weekly&loading=async`,n.async=!0,n.defer=!0,n.onload=()=>e(),n.onerror=t=>a(t),document.head.appendChild(n)}))(t),await new Promise((t,e)=>{let a=0;const n=()=>{a++,window.google&&window.google.maps&&window.google.maps.Map?t():a>50?e(new Error("Timeout waiting for google.maps.Map")):setTimeout(n,100)};n()});let s=!1;if("function"==typeof google.maps.importLibrary)try{const{Map:t}=await google.maps.importLibrary("maps"),{AdvancedMarkerElement:e}=await google.maps.importLibrary("marker");a=t,o=e}catch(t){console.warn("Modern map import failed, falling back to legacy",t),a=google.maps.Map,s=!0}else a=google.maps.Map,s=!0;if(!a)throw new Error("google.maps.Map constructor is missing");const r=e.length>0?{lat:e[0].lat,lng:e[0].lng}:{lat:40.6782,lng:-73.9442};if(i=new a(n,{center:r,zoom:13,mapId:"DEMO_MAP_ID",disableDefaultUI:!1,zoomControl:!0,streetViewControl:!1}),e.length>0){const t=new google.maps.LatLngBounds;e.forEach((e,a)=>{const n={lat:e.lat,lng:e.lng};if(!s&&o){const t=document.createElement("div");t.className="batp-map-marker",t.innerHTML=`<span style="background:#FF5F3D; color:#fff; border-radius:50%; width:32px; height:32px; display:flex; align-items:center; justify-content:center; font-weight:bold; box-shadow:0 2px 4px rgba(0,0,0,0.2); font-size:14px;">${a+1}</span>`,new o({map:i,position:n,content:t,title:e.title})}else new google.maps.Marker({map:i,position:n,label:{text:(a+1).toString(),color:"white",fontWeight:"bold"},title:e.title});t.extend(n)}),i.fitBounds(t)}}catch(t){console.error("Map init error:",t),n.innerHTML='<div style="padding:2rem; color:#d00;">Map failed to load.</div>'}})(r,c)},100)};t.addEventListener("submit",async e=>{e.preventDefault();const a=t.dataset.nonce,n=t.dataset.restNonce,o=t.dataset.apiUrl,s=t.dataset.googleMapsKey;if(!a||!o)return;const i=new FormData(t),l={neighborhood:i.get("neighborhood"),interests:i.getAll("interests[]"),budget:i.get("budget"),duration:60*Number(i.get("duration")),nonce:a},c=t.querySelector('button[type="submit"]'),d=c.innerHTML;c.disabled=!0,c.innerHTML="Generating Plan...";try{const t=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json",...n?{"X-WP-Nonce":n}:{}},body:JSON.stringify(l)}),e=await t.json();if(!t.ok)throw new Error(e.message||"Error generating itinerary");r(e,s)}catch(t){console.error("BATP Error:",t),alert("Error: "+t.message)}finally{c.disabled=!1,c.innerHTML=d}})};"loading"!==document.readyState?t():document.addEventListener("DOMContentLoaded",t)})();