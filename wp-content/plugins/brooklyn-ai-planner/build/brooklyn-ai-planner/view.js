(()=>{const t=()=>{const t=document.querySelector("[data-batp-itinerary-form]");if(!t)return;const e=document.getElementById("batp-results-area"),n=document.getElementById("batp-list-output"),o=document.getElementById("batp-map-root"),a=document.querySelector("[data-batp-results-meta]"),s=document.querySelectorAll(".batp-tabs__btn"),i=Array.from(t.querySelectorAll('.batp-form__chip input[type="checkbox"]')),l=document.getElementById("batp-neighborhood-select"),r=document.getElementById("batp-lat-input"),c=document.getElementById("batp-lng-input"),d=document.getElementById("batp-location-status"),p=t=>{t&&t.dataset.lat&&t.dataset.lng&&(r.value=t.dataset.lat,c.value=t.dataset.lng,d&&(d.textContent=""))};if(l){const t=l.options[l.selectedIndex];p(t),l.addEventListener("change",t=>{const e=t.target.options[t.target.selectedIndex];"current_location"===e.value?(d&&(d.textContent="üì° Getting location..."),navigator.geolocation?navigator.geolocation.getCurrentPosition(t=>{r.value=t.coords.latitude,c.value=t.coords.longitude,d&&(d.textContent="‚úÖ Location found!"),console.log("BATP Geolocation:",t.coords.latitude,t.coords.longitude)},t=>{console.error("Geolocation error:",t),d&&(d.textContent="‚ùå Location failed"),alert("Could not get your location. Please select a neighborhood."),l.value="Brooklyn Heights",p(l.options[l.selectedIndex])},{enableHighAccuracy:!0,timeout:1e4}):(alert("Geolocation is not supported by your browser."),l.value="Brooklyn Heights",p(l.options[l.selectedIndex]))):p(e)})}i.forEach(t=>{t.addEventListener("change",()=>{t.closest(".batp-form__chip").classList.toggle("is-selected",t.checked)})}),s.forEach(t=>{t.addEventListener("click",()=>{s.forEach(t=>t.classList.remove("is-active")),t.classList.add("is-active");const e=t.dataset.tab;document.querySelectorAll(".batp-view-content").forEach(t=>{t.classList.remove("is-active")}),document.getElementById(`batp-view-${e}`).classList.add("is-active"),"map"===e&&u&&setTimeout(()=>{google.maps.event.trigger(u,"resize")},100)})});let u=null;const g=(s,i)=>{const l=s.itinerary?.items||[];if(0===l.length)return void alert("No results found. Try different filters.");if(e&&(e.classList.add("is-active"),e.scrollIntoView({behavior:"smooth"})),a){const e=t.querySelector('select[name="duration"]').value;a.textContent=`${l.length} venues found ‚Ä¢ ${e} hours available`}const r=[],c=new Map((s.candidates||[]).map(t=>[t.slug,t])),d=s.directions?.overview_url||"#";l.forEach((t,e)=>{const n=c.get(t.slug),o=n?.data?.latitude,a=n?.data?.longitude;console.log(`BATP Map: Item ${e+1} (${t.slug}):`,{lat:o,lng:a,title:t.title}),o&&a&&0!==o&&0!==a?r.push({lat:parseFloat(o),lng:parseFloat(a),title:t.title,placeId:t.slug}):console.warn(`BATP Map: Missing coordinates for item ${e+1}: ${t.title}`)}),console.log("BATP Map: Total locations for map:",r.length);const p="#"!==d?d:(t=>{if(0===t.length)return"#";const e=`${t[0].lat},${t[0].lng}`,n=`${t[t.length-1].lat},${t[t.length-1].lng}`,o=t.slice(1,-1).map(t=>`${t.lat},${t.lng}`).join("|");let a=`https://www.google.com/maps/dir/?api=1&origin=${e}&destination=${n}&travelmode=walking`;return o&&(a+=`&waypoints=${o}`),a})(r);let g=[...l];const h=e=>{if(!n)return;const o=`\n\t\t\t\t<div class="batp-route-header">\n\t\t\t\t\t<a href="${p}" target="_blank" class="batp-route-btn" data-event-action="directions_click" data-place-id="full_route">\n\t\t\t\t\t\t<span class="dashicons dashicons-location-alt"></span> \n\t\t\t\t\t\t<strong>Get Full Route Directions</strong>\n\t\t\t\t\t\t<span class="batp-route-btn__subtitle">Open all ${e.length} stops in Google Maps</span>\n\t\t\t\t\t</a>\n\t\t\t\t</div>\n\t\t\t`;n.innerHTML=o+e.map((t,e)=>{const n=c.get(t.slug),o=n?.data||{},a=o.website||"#",s=o.phone_number||o.phone||"",i=o.address||"",l=((t,e)=>{if(e&&e.length>10)return e;if(t.vibe_summary)return t.vibe_summary;const n=[],o=t.rating?`${t.rating}‚òÖ`:"",a=t.price_level?"$".repeat(t.price_level):"",s=t.types?.slice(0,2).map(t=>t.replace(/_/g," ")).join(", ")||"";return o&&n.push(`Rated ${o}`),a&&n.push(a),s&&n.push(s),n.length>0?n.join(" ‚Ä¢ "):"A local Brooklyn favorite."})(o,t.description);let r="See hours on website";var d;o.hours?r=(d=o.hours)?d[["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][(new Date).getDay()]]||"Open today":"See website for hours":o.opening_hours?.open_now&&(r="Open now");let p="#";p=o.latitude&&o.longitude?`https://www.google.com/maps/dir/?api=1&destination=${o.latitude},${o.longitude}`:i?`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(i)}`:`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(t.title+", Brooklyn, NY")}`;const u=n?.place_id||t.slug||"";return`\n\t\t\t\t<div class="batp-card" data-slug="${t.slug}" data-access='${JSON.stringify(o.accessibility||[])}'>\n\t\t\t\t\t<button class="batp-card__remove" data-remove-slug="${t.slug}" title="Remove from itinerary">√ó</button>\n\t\t\t\t\t<div class="batp-card__header">\n\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t<span class="batp-card__status">${!1!==o.opening_hours?.open_now?"Open Now":"Check Hours"}</span>\n\t\t\t\t\t\t\t<h3 class="batp-card__title">${e+1}. ${t.title}</h3>\n\t\t\t\t\t\t\t${o.rating?`<span class="batp-card__rating">‚≠ê ${o.rating}</span>`:""}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t\n\t\t\t\t\t<p class="batp-card__description">${l}</p>\n\t\t\t\t\t\n\t\t\t\t\t<div class="batp-card__details">\n\t\t\t\t\t\t${i?`<div><span class="dashicons dashicons-location"></span> ${i}</div>`:""}\n\t\t\t\t\t\t<div><span class="dashicons dashicons-clock"></span> ${r}</div>\n\t\t\t\t\t\t${s?`<a href="tel:${s.replace(/[^0-9+]/g,"")}" class="batp-card__link-row" data-event-action="phone_click" data-place-id="${u}"><span class="dashicons dashicons-phone"></span> ${s}</a>`:""}\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class="batp-card__footer">\n\t\t\t\t\t\t<a href="${p}" target="_blank" class="batp-card__btn-directions" data-event-action="directions_click" data-place-id="${u}">\n\t\t\t\t\t\t\t<span class="dashicons dashicons-location-alt"></span> Directions\n\t\t\t\t\t\t</a>\n\t\t\t\t\t\t<div class="batp-card__links">\n\t\t\t\t\t\t\t${"#"!==a?`<a href="${a}" target="_blank" data-event-action="website_click" data-place-id="${u}" data-event-meta='${JSON.stringify({url:a})}'><span class="dashicons dashicons-admin-site"></span> Website</a>`:""}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t`}).join(""),n.querySelectorAll(".batp-card__remove").forEach(e=>{e.addEventListener("click",n=>{n.preventDefault();const o=e.dataset.removeSlug;if(g=g.filter(t=>t.slug!==o),h(g),a){const e=t.querySelector('select[name="duration"]').value;a.textContent=`${g.length} venues found ‚Ä¢ ${e} hours available`}})})};h(g);const b=(t,e)=>{const n=document.getElementById(t);n&&e&&(e.onclick=t=>{t.preventDefault(),n.classList.add("is-open"),n.setAttribute("aria-hidden","false")},n.querySelectorAll("[data-modal-close]").forEach(t=>{t.onclick=t=>{t.preventDefault(),n.classList.remove("is-open"),n.setAttribute("aria-hidden","true")}}))},y=document.querySelector(".batp-results__btn--primary");b("batp-share-modal",y),y&&y.addEventListener("click",()=>{const t=document.getElementById("batp-summary-list");t&&(t.innerHTML=l.map(t=>`<li>${t.title}</li>`).join(""));const e=document.getElementById("batp-share-link-input");e&&(e.value=window.location.href)});const w=document.getElementById("batp-btn-copy-link");w&&(w.onclick=()=>{const t=document.getElementById("batp-share-link-input");t.select(),navigator.clipboard.writeText(t.value);const e=w.innerText;w.innerText="Copied!",setTimeout(()=>w.innerText=e,2e3),m("share_copy_link",null,{method:"copy"})});const v=()=>`My Brooklyn Adventure\n\n${l.map((t,e)=>`${e+1}. ${t.title}`).join("\n")}\n\nPlan yours at: ${window.location.href}`,f=document.getElementById("batp-btn-download-pdf");f&&(f.onclick=()=>{const t=`\n\t\t\t\t\t<!DOCTYPE html>\n\t\t\t\t\t<html>\n\t\t\t\t\t<head>\n\t\t\t\t\t\t<title>Brooklyn Itinerary</title>\n\t\t\t\t\t\t<style>\n\t\t\t\t\t\t\tbody { font-family: 'Inter', -apple-system, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; }\n\t\t\t\t\t\t\th1 { color: #8B4513; border-bottom: 2px solid #8B4513; padding-bottom: 10px; }\n\t\t\t\t\t\t\t.venue { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }\n\t\t\t\t\t\t\t.venue h2 { margin: 0 0 8px 0; color: #333; font-size: 18px; }\n\t\t\t\t\t\t\t.venue p { margin: 4px 0; color: #666; font-size: 14px; }\n\t\t\t\t\t\t\t.footer { margin-top: 40px; text-align: center; color: #999; font-size: 12px; }\n\t\t\t\t\t\t</style>\n\t\t\t\t\t</head>\n\t\t\t\t\t<body>\n\t\t\t\t\t\t<h1>My Brooklyn Adventure</h1>\n\t\t\t\t\t\t<p>Generated on ${(new Date).toLocaleDateString()}</p>\n\t\t\t\t\t\t${l.map((t,e)=>`\n\t\t\t\t\t\t\t<div class="venue">\n\t\t\t\t\t\t\t\t<h2>${e+1}. ${t.title}</h2>\n\t\t\t\t\t\t\t\t<p>${t.address||""}</p>\n\t\t\t\t\t\t\t\t${t.phone?`<p>Phone: ${t.phone}</p>`:""}\n\t\t\t\t\t\t\t\t${t.website?`<p>Website: ${t.website}</p>`:""}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t`).join("")}\n\t\t\t\t\t\t<div class="footer">\n\t\t\t\t\t\t\t<p>Created with Brooklyn AI Trip Planner</p>\n\t\t\t\t\t\t\t<p>${window.location.origin}</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</body>\n\t\t\t\t\t</html>\n\t\t\t\t`,e=window.open("","_blank");e.document.write(t),e.document.close(),e.print(),m("share_download_pdf",null,{venues:l.length})});const k=document.getElementById("batp-btn-add-calendar");k&&(k.onclick=()=>{const t=new Date,e=new Date(t);e.setDate(e.getDate()+1),e.setHours(10,0,0,0);const n=t=>t.toISOString().replace(/[-:]/g,"").split(".")[0]+"Z",o=l.map(t=>t.title).join(", "),a=`Brooklyn Adventure:\\n\\n${l.map((t,e)=>`${e+1}. ${t.title}${t.address?" - "+t.address:""}`).join("\\n")}`,s=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Brooklyn AI Trip Planner//EN","BEGIN:VEVENT",`UID:${Date.now()}@visitbrooklynnyc`,`DTSTAMP:${n(t)}`,`DTSTART:${n(e)}`,`DTEND:${n(new Date(e.getTime()+144e5))}`,"SUMMARY:Brooklyn Adventure",`DESCRIPTION:${a}`,`LOCATION:${o}`,"END:VEVENT","END:VCALENDAR"].join("\r\n"),i=new Blob([s],{type:"text/calendar;charset=utf-8"}),r=document.createElement("a");r.href=URL.createObjectURL(i),r.download="brooklyn-itinerary.ics",r.click(),URL.revokeObjectURL(r.href),m("share_add_calendar",null,{venues:l.length})});const _=document.getElementById("batp-btn-share-email");_&&(_.onclick=()=>{const t=encodeURIComponent("Check out my Brooklyn itinerary!"),e=encodeURIComponent(v());window.open(`mailto:?subject=${t}&body=${e}`,"_self"),m("share_email",null,{venues:l.length})});const $=document.getElementById("batp-btn-share-sms");$&&($.onclick=()=>{const t=encodeURIComponent(v());window.open(`sms:?body=${t}`,"_self"),m("share_sms",null,{venues:l.length})});const E=encodeURIComponent(window.location.href),I=encodeURIComponent(`I just planned a Brooklyn adventure with ${l.length} stops!`),B=document.getElementById("batp-btn-share-facebook");B&&(B.onclick=()=>{window.open(`https://www.facebook.com/sharer/sharer.php?u=${E}`,"_blank","width=600,height=400"),m("share_social",null,{platform:"facebook"})});const T=document.getElementById("batp-btn-share-x");T&&(T.onclick=()=>{window.open(`https://twitter.com/intent/tweet?url=${E}&text=${I}`,"_blank","width=600,height=400"),m("share_social",null,{platform:"x"})});const x=document.getElementById("batp-btn-share-whatsapp");x&&(x.onclick=()=>{window.open(`https://wa.me/?text=${I}%20${E}`,"_blank"),m("share_social",null,{platform:"whatsapp"})});const A=document.getElementById("batp-btn-share-linkedin");A&&(A.onclick=()=>{window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${E}`,"_blank","width=600,height=400"),m("share_social",null,{platform:"linkedin"})});const S=document.getElementById("batp-btn-share-instagram");S&&(S.onclick=()=>{const t=v();navigator.clipboard.writeText(t).then(()=>{alert("Itinerary copied to clipboard! Opening Instagram - paste in your story or post."),window.open("https://www.instagram.com/","_blank")}),m("share_social",null,{platform:"instagram"})});const L=document.getElementById("batp-btn-share-tiktok");L&&(L.onclick=()=>{const t=v();navigator.clipboard.writeText(t).then(()=>{alert("Itinerary copied to clipboard! Opening TikTok - paste in your video description."),window.open("https://www.tiktok.com/","_blank")}),m("share_social",null,{platform:"tiktok"})}),b("batp-filter-modal",document.querySelector(".batp-results__btn:nth-child(2)"));const M=document.getElementById("batp-apply-filters");M&&(M.onclick=()=>{const t=document.getElementById("batp-filter-modal"),e=t.querySelector('input[name="access_wheelchair"]').checked,o=t.querySelector('input[name="access_sensory"]').checked,a=t.querySelector('input[name="access_seating"]').checked;n.querySelectorAll(".batp-card").forEach(t=>{const n=JSON.parse(t.dataset.access||"[]");let s=!0;e&&!n.includes("wheelchair")&&(s=!1),o&&!n.includes("sensory")&&(s=!1),a&&!n.includes("seating")&&(s=!1),t.style.display=s?"flex":"none"}),t.classList.remove("is-open")}),i&&r.length>0&&setTimeout(()=>{(async(t,e=[])=>{if(o)try{let n,a;await(t=>new Promise((e,n)=>{if(window.google&&window.google.maps)return void e();if(document.querySelector('script[src*="maps.googleapis.com/maps/api/js"]'))return void e();const o=document.createElement("script");o.src=`https://maps.googleapis.com/maps/api/js?key=${t}&libraries=places,geometry,marker&v=weekly&loading=async`,o.async=!0,o.defer=!0,o.onload=()=>e(),o.onerror=t=>n(t),document.head.appendChild(o)}))(t),await new Promise((t,e)=>{let n=0;const o=()=>{n++,window.google&&window.google.maps&&window.google.maps.Map?t():n>50?e(new Error("Timeout waiting for google.maps.Map")):setTimeout(o,100)};o()});let s=!1;if("function"==typeof google.maps.importLibrary)try{const{Map:t}=await google.maps.importLibrary("maps"),{AdvancedMarkerElement:e}=await google.maps.importLibrary("marker");n=t,a=e}catch(t){console.warn("Modern map import failed, falling back to legacy",t),n=google.maps.Map,s=!0}else n=google.maps.Map,s=!0;if(!n)throw new Error("google.maps.Map constructor is missing");const i=e.length>0?{lat:e[0].lat,lng:e[0].lng}:{lat:40.6782,lng:-73.9442};if(u=new n(o,{center:i,zoom:13,mapId:"DEMO_MAP_ID",disableDefaultUI:!1,zoomControl:!0,streetViewControl:!1}),e.length>0){const t=new google.maps.LatLngBounds;e.forEach((e,n)=>{const o={lat:e.lat,lng:e.lng};if(!s&&a){const t=document.createElement("div");t.className="batp-map-marker",t.innerHTML=`<span style="background:#FF5F3D; color:#fff; border-radius:50%; width:32px; height:32px; display:flex; align-items:center; justify-content:center; font-weight:bold; box-shadow:0 2px 4px rgba(0,0,0,0.2); font-size:14px;">${n+1}</span>`,new a({map:u,position:o,content:t,title:e.title})}else new google.maps.Marker({map:u,position:o,label:{text:(n+1).toString(),color:"white",fontWeight:"bold"},title:e.title});t.extend(o)}),u.fitBounds(t)}}catch(t){console.error("Map init error:",t),o.innerHTML='<div style="padding:2rem; color:#d00;">Map failed to load.</div>'}})(i,r)},100)},m=async(e,n,o={})=>{const a=t.dataset.nonce,s=t.dataset.restNonce,i=t.dataset.apiUrl.replace("/itinerary","/events");if(console.log("BATP trackEvent:",e,n,o),!a||!i)return void console.warn("BATP trackEvent: Missing nonce or eventsUrl");const l={...o,source:"web_client"};try{const t=await fetch(i,{method:"POST",keepalive:!0,headers:{"Content-Type":"application/json",...s?{"X-WP-Nonce":s}:{}},body:JSON.stringify({action_type:e,place_id:n,metadata:l,nonce:a})});console.log("BATP trackEvent response:",t.status,t.ok)}catch(t){console.warn("BATP Analytics fail:",t)}};n&&n.addEventListener("click",t=>{const e=t.target.closest("[data-event-action]");if(e){const t=e.dataset.eventAction,n=e.dataset.placeId||"",o=e.dataset.eventMeta?JSON.parse(e.dataset.eventMeta):{};console.log("BATP Analytics:",t,n,o),m(t,n,o)}}),t.addEventListener("submit",async e=>{e.preventDefault();const n=t.dataset.nonce,o=t.dataset.restNonce,a=t.dataset.apiUrl,s=t.dataset.googleMapsKey;if(!n||!a)return;const i=new FormData(t),l=parseFloat(i.get("latitude"))||40.6782,r=parseFloat(i.get("longitude"))||-73.9442,c=i.get("neighborhood");console.log("BATP Form: Submitting with location:",{neighborhood:c,lat:l,lng:r});const d={neighborhood:c,lat:l,lng:r,interests:i.getAll("interests[]"),budget:i.get("budget"),duration:60*Number(i.get("duration")),nonce:n},p=t.querySelector('button[type="submit"]'),u=p.innerHTML;p.disabled=!0,p.innerHTML="Generating Plan...";try{const t=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json",...o?{"X-WP-Nonce":o}:{}},body:JSON.stringify(d)}),e=await t.json();if(!t.ok)throw new Error(e.message||"Error generating itinerary");g(e,s)}catch(t){console.error("BATP Error:",t),alert("Error: "+t.message)}finally{p.disabled=!1,p.innerHTML=u}})};"loading"!==document.readyState?t():document.addEventListener("DOMContentLoaded",t)})();